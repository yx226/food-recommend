<!DOCTYPE html>
<html lang="zh-CN">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤–å–åˆ†ç±» - {{ current_category }}</title>
    <style>
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .category-tabs { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; justify-content: center; }
        .category-tab { padding: 10px 20px; border: 2px solid #e0e0e0; border-radius: 25px; background: white; cursor: pointer; transition: all 0.3s ease; font-size: 14px; text-decoration: none; color: inherit; }
        .category-tab:hover { border-color: #ff6b6b; transform: translateY(-2px); text-decoration: none; color: inherit; }
        .category-tab.active { background: #ff6b6b; color: white; border-color: #ff6b6b; }
        .foods-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .food-card { border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; background: white; transition: all 0.3s ease; }
        .food-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .food-image { width: 100%; height: 180px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 14px; overflow: hidden; position: relative; }
        .food-image img { width: 100%; height: 100%; object-fit: cover; }
        .food-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #333; }
        .food-shop { color: #666; font-size: 14px; margin-bottom: 5px; }
        
        /* è¯„åˆ†æ ·å¼ */
        .food-rating { 
            display: flex; 
            align-items: center; 
            margin-bottom: 8px; 
            font-size: 14px;
        }
        .rating-stars { 
            color: #ffc107; 
            margin-right: 5px;
        }
        .rating-score { 
            font-weight: bold; 
            color: #ff6b6b; 
            margin-right: 5px;
        }
        .rating-count { 
            color: #999; 
            font-size: 12px;
        }
        
        .food-price { color: #ff6b6b; font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .food-original-price { color: #999; text-decoration: line-through; font-size: 14px; margin-left: 5px; }
        .food-sales { color: #666; font-size: 12px; margin-bottom: 10px; }
        .food-info { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .delivery-time { background: #e8f5e8; color: #4CAF50; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .min-order { color: #666; font-size: 12px; }
        .rating-btn { background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px; width: 100%; margin-top: 10px; transition: background 0.3s ease; }
        .rating-btn:hover { background: #45a049; }
        .rating-btn:disabled { background: #cccccc; cursor: not-allowed; }
        .rating-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .rating-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .rating-stars-modal { display: flex; justify-content: center; gap: 10px; margin: 20px 0; font-size: 30px; }
        .star { cursor: pointer; color: #ddd; transition: color 0.2s ease; }
        .star:hover, .star.active { color: #ffc107; }
        .rating-comment { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical; margin-bottom: 20px; }
        .rating-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .cancel-btn { background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .submit-btn { background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 30px; }
        .page-btn { padding: 8px 16px; border: 1px solid #e0e0e0; background: white; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; }
        .page-btn.active { background: #ff6b6b; color: white; border-color: #ff6b6b; }
        .page-btn:hover:not(.active) { border-color: #ff6b6b; color: #ff6b6b; }
        .stats { text-align: center; color: #666; margin-bottom: 20px; font-size: 16px; }
        .health-tip { background: #e8f5e8; border-left: 4px solid #4CAF50; padding: 15px; margin-bottom: 20px; border-radius: 5px; font-size: 14px; }
        .empty-state { grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #999; }
        .empty-state p { margin: 10px 0; font-size: 16px; }
        .debug-info { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px; padding: 15px; margin-bottom: 20px; font-family: monospace; font-size: 12px; color: #6c757d; display: none; }
        .id-debug { font-size: 10px; color: #999; background: #f5f5f5; padding: 2px 5px; border-radius: 3px; margin-bottom: 5px; }
        .error-message { background: #ffe6e6; border: 1px solid #ffcccc; border-radius: 5px; padding: 10px; margin: 10px 0; color: #d63031; font-size: 14px; display: none; }
        
        /* è¯„åˆ†è§’æ ‡æ ·å¼ */
        .rating-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div class="debug-info" id="debugInfo">
            <strong>è°ƒè¯•ä¿¡æ¯:</strong><br>
            æ€»èœå“æ•°: {{ total_foods }}<br>
            å½“å‰é¡µèœå“æ•°: {{ foods|length }}<br>
            å½“å‰é¡µç : {{ current_page }}<br>
            æ€»é¡µæ•°: {{ total_pages }}<br>
            å½“å‰åˆ†ç±»: {{ current_category }}<br>
        </div>

        <!-- é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º -->
        <div class="error-message" id="errorMessage"></div>

        <div class="header">
            <h1>{{ current_category }}</h1>
            <p>åŸºäºæ‚¨çš„å£å‘³åå¥½ï¼Œå‘ç°å‘¨è¾¹çš„ä¼˜è´¨å¤–å–</p>
        </div>
        
        <!-- å¥åº·æç¤º -->
        {% if health_tip %}
        <div class="health-tip">
            <strong>{{ health_tip }}</strong>: {{ health_advice }}
        </div>
        {% endif %}
        
        <!-- åˆ†ç±»æ ‡ç­¾ -->
        <div class="category-tabs">
            {% for key, description in categories.items %}
            <a href="{% if key == 'å…¨éƒ¨' %}{% url 'category' %}{% else %}{% url 'category_detail' key %}{% endif %}" 
               style="text-decoration: none;">
                <div class="category-tab {% if current_category == key %}active{% endif %}">
                    {{ key }}
                </div>
            </a>
            {% endfor %}
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats">
            å…±æ‰¾åˆ° <strong>{{ total_foods }}</strong> ä¸ªèœå“
        </div>
        
        <!-- èœå“ç½‘æ ¼ -->
        <div class="foods-grid">
            {% for food in foods %}
            <div class="food-card">
                <div class="food-image">
                    {% if food.å•†é“ºé“¾æ¥ %}
                    <img src="{{ food.å•†é“ºé“¾æ¥ }}" alt="{{ food.èœå“ }}" onerror="this.style.display='none'; this.parentNode.innerHTML='ğŸ½ï¸ èœå“å›¾ç‰‡';">
                    {% else %}
                    ğŸ½ï¸ èœå“å›¾ç‰‡
                    {% endif %}
                    
                    <!-- è¯„åˆ†è§’æ ‡ -->
                    <div class="rating-badge">
                        â­ {{ food.average_rating|default:food.è¯„åˆ†|default:"5.0" }}
                    </div>
                </div>
                
                <div class="food-name">{{ food.èœå“|default:"æœªçŸ¥èœå“" }}</div>
                <div class="food-shop">ğŸª {{ food.å•†é“ºåç§°|default:"æœªçŸ¥å•†å®¶" }}</div>
                
                <!-- è¯„åˆ†æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="food-rating">
                    <span class="rating-stars">
                        {% with rating=food.average_rating|default:food.è¯„åˆ†|default:5.0 %}
                            {% if rating %}
                                {% for i in "12345" %}
                                    {% if forloop.counter <= rating %}
                                        â˜…
                                    {% else %}
                                        â˜†
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                â˜†â˜†â˜†â˜†â˜†
                            {% endif %}
                        {% endwith %}
                    </span>
                    <span class="rating-score">{{ food.average_rating|default:food.è¯„åˆ†|default:"5.0" }}</span>
                    <span class="rating-count">
                        ({{ food.rating_count|default:"0" }}è¯„ä»·)
                    </span>
                </div>
                
                <!-- IDè°ƒè¯•ä¿¡æ¯ -->
                <div class="id-debug">
                    ID: {% if food.id %}{{ food.id }}{% else %}æœªè®¾ç½®ID{% endif %}
                </div>
                
                <div>
                    <span class="food-price">ï¿¥{{ food.ä»·æ ¼|default:"0" }}</span>
                    {% if food.åŸä»· and food.åŸä»· > food.ä»·æ ¼ %}
                    <span class="food-original-price">ï¿¥{{ food.åŸä»· }}</span>
                    {% endif %}
                </div>
                
                <div class="food-sales">æœˆå”®{{ food.æœˆé”€é‡|default:0 }}</div>
                
                <div class="food-info">
                    <div class="delivery-time">
                        ğŸš´ {{ food.é…é€æ—¶é—´|default:30 }}åˆ†é’Ÿ
                    </div>
                    <div class="min-order">
                        èµ·é€ï¿¥{{ food.èµ·é€ä»·|default:20 }}
                    </div>
                </div>
                
                <!-- è¯„ä»·æŒ‰é’® -->
                <button class="rating-btn" 
                        onclick="openRatingModal('{{ food.èœå“|escapejs }}', '{{ food.å•†é“ºåç§°|escapejs }}', '{{ food.id|default:"" }}')"
                        {% if not food.id %}disabled title="æ­¤èœå“æš‚æ—¶æ— æ³•è¯„ä»·"{% endif %}>
                    â­ è¯„ä»·èœå“
                </button>
            </div>
            {% empty %}
            <div class="empty-state">
                <p>ğŸ˜” æš‚æ— æ¨èèœå“</p>
                <p>è¯·å°è¯•å…¶ä»–åˆ†ç±»æˆ–ç¨åå†æ¥</p>
                <p style="font-size: 14px; margin-top: 10px;">æˆ–è€…è”ç³»å®¢æœè·å–å¸®åŠ©</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- åˆ†é¡µ -->
        {% if total_pages > 1 %}
        <div class="pagination">
            {% if current_page > 1 %}
            <a href="?page={{ current_page|add:-1 }}{% if current_category != 'å…¨éƒ¨' %}&category={{ current_category }}{% endif %}">
                <button class="page-btn">ä¸Šä¸€é¡µ</button>
            </a>
            {% endif %}
            
            {% for page_num in page_range %}
            {% if page_num == current_page %}
            <button class="page-btn active">{{ page_num }}</button>
            {% else %}
            <a href="?page={{ page_num }}{% if current_category != 'å…¨éƒ¨' %}&category={{ current_category }}{% endif %}">
                <button class="page-btn">{{ page_num }}</button>
            </a>
            {% endif %}
            {% endfor %}
            
            {% if current_page < total_pages %}
            <a href="?page={{ current_page|add:1 }}{% if current_category != 'å…¨éƒ¨' %}&category={{ current_category }}{% endif %}">
                <button class="page-btn">ä¸‹ä¸€é¡µ</button>
            </a>
            {% endif %}
        </div>
        
        <div style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">
            ç¬¬ {{ current_page }} é¡µï¼Œå…± {{ total_pages }} é¡µ
        </div>
        {% endif %}
    </div>

    <!-- è¯„ä»·æ¨¡æ€æ¡† -->
    <div id="ratingModal" class="rating-modal">
        <div class="rating-content">
            <h3 id="ratingTitle">è¯„ä»·èœå“</h3>
            <p id="ratingDescription"></p>
            
            <div class="rating-stars-modal">
                <span class="star" data-rating="1">â˜…</span>
                <span class="star" data-rating="2">â˜…</span>
                <span class="star" data-rating="3">â˜…</span>
                <span class="star" data-rating="4">â˜…</span>
                <span class="star" data-rating="5">â˜…</span>
            </div>
            
            <div style="text-align: center; margin-bottom: 15px; color: #666;">
                <small id="ratingText">è¯·é€‰æ‹©è¯„åˆ†</small>
            </div>
            
            <textarea class="rating-comment" id="ratingComment" placeholder="è¯·è¾“å…¥æ‚¨çš„è¯„ä»·ï¼ˆå¯é€‰ï¼‰..."></textarea>
            
            <div class="rating-actions">
                <button class="cancel-btn" onclick="closeRatingModal()">å–æ¶ˆ</button>
                <button class="submit-btn" onclick="submitRating()" id="submitRatingBtn">
                    æäº¤è¯„ä»·
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentRating = 0;
        let currentFoodId = '';
        let currentFoodName = '';
        let currentShopName = '';

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            initStarRating();
            
            // è°ƒè¯•é¢æ¿å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    const debugInfo = document.getElementById('debugInfo');
                    debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
                }
            });
        });

        // åˆå§‹åŒ–æ˜Ÿæ˜Ÿè¯„åˆ†
        function initStarRating() {
            const stars = document.querySelectorAll('.rating-stars-modal .star');
            stars.forEach(star => {
                // ç‚¹å‡»äº‹ä»¶
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    currentRating = rating;
                    updateStarsDisplay();
                    updateRatingText();
                });
                
                // é¼ æ ‡æ‚¬åœæ•ˆæœ
                star.addEventListener('mouseover', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    highlightStars(rating);
                });
                
                star.addEventListener('mouseout', function() {
                    updateStarsDisplay();
                });
            });
        }

        // æ›´æ–°æ˜Ÿæ˜Ÿæ˜¾ç¤º
        function updateStarsDisplay() {
            const stars = document.querySelectorAll('.rating-stars-modal .star');
            stars.forEach((star, index) => {
                if (index < currentRating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // é«˜äº®æ˜Ÿæ˜Ÿï¼ˆæ‚¬åœæ•ˆæœï¼‰
        function highlightStars(rating) {
            const stars = document.querySelectorAll('.rating-stars-modal .star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.style.color = '#ffc107';
                } else {
                    star.style.color = '#ddd';
                }
            });
        }

        // æ›´æ–°è¯„åˆ†æ–‡æœ¬
        function updateRatingText() {
            const ratingTexts = {
                1: "å¾ˆå·® - ä¸æ¨è",
                2: "ä¸€èˆ¬ - æœ‰å¾…æ”¹è¿›", 
                3: "è¿˜è¡Œ - ä¸­è§„ä¸­çŸ©",
                4: "å¾ˆå¥½ - æ¨èå°è¯•",
                5: "å®Œç¾ - å¼ºçƒˆæ¨è"
            };
            const ratingTextElement = document.getElementById('ratingText');
            if (ratingTextElement) {
                ratingTextElement.textContent = ratingTexts[currentRating] || "è¯·é€‰æ‹©è¯„åˆ†";
            }
        }

        // æ‰“å¼€è¯„ä»·æ¨¡æ€æ¡†
        function openRatingModal(foodName, shopName, foodId) {
            console.log('æ‰“å¼€è¯„ä»·æ¨¡æ€æ¡†å‚æ•°:', { 
                foodName: foodName, 
                shopName: shopName, 
                foodId: foodId 
            });
            
            // éªŒè¯èœå“ID
            if (!foodId || foodId === 'None' || foodId === 'null' || foodId === 'undefined' || foodId === '') {
                console.error('æ— æ•ˆçš„èœå“ID:', foodId);
                showError('èœå“ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è¿›è¡Œè¯„ä»·');
                return;
            }
            
            // è®¾ç½®å½“å‰èœå“ä¿¡æ¯
            currentFoodName = foodName;
            currentShopName = shopName;
            currentFoodId = foodId;
            currentRating = 0;
            
            // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
            document.getElementById('ratingTitle').textContent = `è¯„ä»· ${foodName}`;
            document.getElementById('ratingDescription').innerHTML = `<i class="fas fa-store"></i> å•†å®¶: ${shopName}`;
            document.getElementById('ratingComment').value = '';
            
            // é‡ç½®æ˜Ÿæ˜Ÿå’Œæ–‡æœ¬
            updateStarsDisplay();
            updateRatingText();
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('ratingModal').style.display = 'flex';
            
            console.log('è¯„ä»·æ¨¡æ€æ¡†å·²æ‰“å¼€ï¼Œèœå“ID:', currentFoodId);
        }

        // å…³é—­è¯„ä»·æ¨¡æ€æ¡†
        function closeRatingModal() {
            document.getElementById('ratingModal').style.display = 'none';
            currentRating = 0;
            currentFoodId = '';
            currentFoodName = '';
            currentShopName = '';
        }

        // æäº¤è¯„ä»·
        function submitRating() {
            console.log('å¼€å§‹æäº¤è¯„ä»·:', {
                foodId: currentFoodId,
                rating: currentRating,
                foodName: currentFoodName,
                shopName: currentShopName
            });
            
            // éªŒè¯è¯„åˆ†
            if (currentRating === 0) {
                showError('è¯·é€‰æ‹©è¯„åˆ†');
                return;
            }
            
            // å†æ¬¡éªŒè¯èœå“ID
            if (!currentFoodId) {
                console.error('æäº¤è¯„ä»·æ—¶èœå“IDä¸ºç©º');
                showError('èœå“ä¿¡æ¯é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            const comment = document.getElementById('ratingComment').value;
            const submitBtn = document.getElementById('submitRatingBtn');
            
            // ç¦ç”¨æäº¤æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading"></div>æäº¤ä¸­...';
            
            // å‡†å¤‡æäº¤æ•°æ®
            const ratingData = {
                food_id: currentFoodId,
                rating: currentRating,
                comment: comment,
                food_name: currentFoodName,
                shop_name: currentShopName
            };
            
            console.log('æäº¤è¯„ä»·æ•°æ®:', ratingData);
            
            // å‘é€è¯„ä»·è¯·æ±‚
            fetch("{% url 'submit_rating' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(ratingData)
            })
            .then(response => {
                console.log('å“åº”çŠ¶æ€:', response.status);
                console.log('å“åº”URL:', response.url);
                
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('æœåŠ¡å™¨å“åº”:', data);
                
                if (data.success) {
                    // æˆåŠŸæç¤º
                    showSuccess(`è¯„ä»·æˆåŠŸï¼\nâ­ è¯„åˆ†: ${currentRating}æ˜Ÿ\nğŸ½ï¸ èœå“: ${currentFoodName}`);
                    closeRatingModal();
                    
                    // å»¶è¿Ÿåˆ·æ–°é¡µé¢ä»¥æ›´æ–°è¯„åˆ†æ˜¾ç¤º
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                    
                } else {
                    throw new Error(data.message || 'è¯„ä»·å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('è¯„ä»·æäº¤é”™è¯¯:', error);
                showError('è¯„ä»·æäº¤å¤±è´¥: ' + error.message);
                
                // å¦‚æœæ˜¯ç™»å½•é—®é¢˜ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                if (error.message.includes('è¯·å…ˆç™»å½•')) {
                    setTimeout(() => {
                        window.location.href = "{% url 'login' %}";
                    }, 2000);
                }
            })
            .finally(() => {
                // é‡æ–°å¯ç”¨æäº¤æŒ‰é’®
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'æäº¤è¯„ä»·';
            });
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            // ä½¿ç”¨alertä½œä¸ºç®€å•æç¤ºï¼Œå¯ä»¥æ›¿æ¢ä¸ºæ›´ä¼˜é›…çš„Toast
            alert('âœ… ' + message);
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                
                // 5ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            } else {
                // å¤‡ç”¨é”™è¯¯æç¤º
                alert('âŒ ' + message);
            }
        }

        // è·å– CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('ratingModal');
            if (e.target === modal) {
                closeRatingModal();
            }
        });
        
        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(e) {
            if (e.key === "Escape") {
                closeRatingModal();
            }
        });

        // è°ƒè¯•å‡½æ•°
        function debugRating() {
            console.log('å½“å‰è¯„åˆ†çŠ¶æ€:', {
                currentRating: currentRating,
                currentFoodId: currentFoodId,
                currentFoodName: currentFoodName,
                currentShopName: currentShopName
            });
        }
    </script>
</body>
</html>